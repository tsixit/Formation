---
# Bootstraping
- hosts: all
  name: Bootstraping des vms
  vars:
    message: " Bonjour !"
  tasks:
    - name: Vérification de l'absence du fichier OOaptproxy
      file:
        path: /etc/apt/apt.conf.d/00aptproxy
        state: absent
      when: "ansible_os_family == 'Debian'"
    - name: Installation serveur ssh et sudo
      # apt:
      package:
        name: openssh-server,sudo
        state: present
    - name: Démarrer le service sshd et démarrer au boot
      service:
        name: sshd
        state: started
        enabled: 'yes'
        # enabled permet de démarrer le service au boot
    - name: Déploiement clé ssh pour root
      copy:
        src: key/serverkey.pub
        dest: /root/.ssh/authorized_keys
        mode: 0600
        owner: root
        group: root
    - name: Garantir le fichier /etc/motd
      copy:
        dest: /etc/motd
        content: "{{ message | default('Coucou ! ') }}\n
        Ce système est géré par Ansible et tourne sur {{ ansible_distribution }}\n
        Version du noyau : {{ ansible_kernel }}\n
        Mon IP est : {{ ansible_default_ipv4.address}}\n"
        mode: 0644
        owner: root
        group: root
- hosts: all
  name: "Deuxième partie: Conf ssh"
  handlers:
    # Une tache qui va être appelé par une autre tache
    - name: Relance sshd
      service:
        name: sshd
        state: reloaded
  tasks:
    - name: Nouveau fichier sshd
      # module permettnat de modifier une ligne dans un fichier de conf
      lineinfile:
        path: /etc/ssh/sshd_config
        line: PermitRootLogin without-password
        regexp: "^#?PermitRootLogin .*"
        state: present
        owner: root
        group: root
        mode: 0644
      notify:
        # liste des noms des handlers qui va être appéler par ce task
        - Relance sshd
- hosts: all
  name: "Troisieme partie: Gestion des  hostnames"
  tasks:
    - name: Changement des hostnames
      hostname:
        name: "{{ inventory_hostname }}"
- hosts: all
  name: Gestion utilisateur
  tasks:
    - name: utilisateur ansible
      user:
        name: ansible
        home: /home/ansible/
        shell: /bin/bash
    - name: Ajout dans sudoers
      copy:
        dest: /etc/sudoers.d/ansible_sudoers
        content: "ansible  ALL=(ALL:ALL) NOPASSWD: ALL"
    - name: Répertoire ssh
      file:
        path: /home/ansible/.ssh
        state: directory
    - name: Deploiement clé
      authorized_key:
        user: ansible
        manage_dir: yes
        key: "{{ lookup('file', 'key/mykey.pub')}}"
