---
# Bootstraping
- hosts: all
  name: Bootstraping des vms
  tasks:
    - name: Vérification de l'absence du fichier OOaptproxy
      file:
        path: /etc/apt/apt.conf.d/00aptproxy
        state: absent
    - name: Installation serveur ssh
      apt:
        name: openssh-server
        state: present
    - name: Démarrer le service sshd et démarrer au boot
      service:
        name: sshd
        state: started
        enabled: 'yes'
        # enabled permet de démarrer le service au boot
    - name: Déploiement clé ssh pour root
      copy:
        src: key/serverkey.pub
        dest: /root/.ssh/authorized_keys
        mode: 0600
        owner: root
        group: root
    - name: Garantir le fichier /etc/motd
      copy:
        dest: /etc/motd
        content: "Ce système est géré par Ansible\n"
        mode: 0644
        owner: root
        group: root
- hosts: all
  name: "Deuxième partie: Conf ssh"
  handlers:
  # Une tache qui va être appelé par une autre tache quand il y a un changement de ce dernier 
    - name: Relance sshd
      service: sshd
      state: reloaded
  tasks:
    - name: Nouveau fichier sshd
    # Permet de modifier une ligne dans le fichier de conf
      lineinfile: 
        path: /etc/ssh/sshd_config
        line: PermitRootLogin without-password
        regexp: "^#?PermitRootLogin .*"
        state: present
        owner: root
        group: root
        mode: 0644
      notify: 
        # Une liste des noms des handlers qui va être appéler s'il y a eu un changement
        - Relance sshd 
